---

layout:     post
title:      计算机网络（三）
subtitle:   数据链路层
date:       2019-11-31
author:     Mavis
header-img: img/博客背景.jpg
catalog: true
tags:
    - 计算机网络
---

## 1. 简介

**在本章中我们研究的是在同一个局域网中,分组怎样从一台主机传送到另一台主机,但并不经过路由器转发。** 从整个互联网来看,局域网仍属于数据链路层的范围，并不将其放到网络层中讨论，因为网络层讨论的是分组怎么从一个网络通过路由器转发到另一个网络。

数据链路层使用的信道主要有以下两种类型：

* **点对点信道**：一对一的点对点通信方式。
* **广播信道**：一对多的广播通信方式。

本章最重要的内容是:

* 数据链路层的点对点信道和广播信道的特点,以及这两种信道所使用的协议(**PPP协议以及CSMA/CD协议**)的特点。
* 数据链路层的三个基本问题:**封装成帧、透明传输和差错检测**。
* 以太网**MAC层的硬件地址**。
* 适配器、转发器、集线器、网桥、以太网交换机的作用以及使用场合。

## 2. 使用点对点信道的数据链路层

### 2.1 基本术语

（1）**链路 (link):** 就是从一个结点到相邻结点的一段物理线路(有线或无线),而中间没有任何其他的交换结点。在进行数据通信时,两台计算机之间的通信路径往往要经过许多段这样的链路。可见链路只是一条路径的组成部分。

（2）**数据链路(data link):** 当需要在一条线路上传送数据时,除了必须有一条物理线路外,还必须有一些必要的通信协议来控制这些数据的传输，若把实现这些协议的硬件和软件加到链路上,就构成了数据链路。现在最常用的方法是使用网络适配器(既有硬件,也包括软件)来实现这些协议。

（3）**数据通信协议** 曾叫做通信规程(procedure)，在数据链路层,规程和协议是同义语。

（4）**帧：** 点对点信道的数据链路层的协议数据单元。

### 2.2 基本问题

#### 2.2.1 封装成帧(framing)

​		**封装成帧就是在一段数据的前后分别添加首部和尾部,这样就构成了一个帧。** 帧就是数据链路层的数据传送单元。**一个帧的帧长等于帧的数据部分长度加上帧首部和帧尾部的长度。** 首部和尾部的一个重要作用就是进行帧定界(即确定帧的界限)。此外,首部和尾部还包括许多必要的控制信息。在发送帧时,是从帧首部开始发送的。**各种数据链路层协议都对帧首部和帧尾部的格式有明确的规定。** 为了提高帧的传输效率,应当使帧的数据部分长度尽可能地大于首部和尾部的长度。每一种链路层协议都规定了所能传送的**帧的数据部分长度上限—最大传送单元MTU(Maximum Transfer Unit)**。

​		**控制字符SOH(Start Of Header) 表示帧的首部开始**，**控制字符EOT(End Of Transmission)表示帧的结束**。**针对差错数据(只有首部开始符SOH而没有传输结束符EOT)，直接丢弃，完整数据予以保留。**

#### 2.2.2 透明传输

​		在数据链路层**透明** 传送数据表示无论什么样的比特组合的数据,都能够按照原样没有差错地通过这个数据链路层。由于上面已经使用专门的控制字符（8比特）来标识SOH和EOT。所传输的数据中若是出现一样的比特编码就会出现帧定界的错误（误将数据当作界定符）。**只有当输入数据无上述差错传输成功时才可称作透明传输。**

​		当数据部分是文本文件时，自然不会出现上述差错；但当数据部分是非ASCⅡ码的文本文件时(如二进制代码的计算机程序或图像等), 如果数据中的某个字节的二进制代码恰好和SOH或EOT这种控制字符一样,数据链路层就会错误地“找到帧的边界”,把部分帧收下(误认为是个完整的帧),而把剩下的那部分数据丢弃。

​		**解决方案：** **发送端在数据中出现控制字符SOH或EOT的前面插入一个转义字符ESC** (其十六进制编码是1B,二进制是00011011)。**接收端把数据送往网络层之前删除这个插入的转义字符**。称为字节填充(byte stuffing)或字符填充(character stuffing)。**如果转义字符也出现在数据当中,那么解决方法仍然是在转义字符的前面插入一个转义字符**。因此,当接收端收到连续的两个转义字符时,就删除其中前面的一个。

#### 2.2.3 差错检测

**（1）比特差错：** 现实的通信链路都不会是理想的，比特在传输过程中可能会产生差错:1可能会变成0,而0也可能变成1。这就叫做**比特差错**。比特差错是传输差错中的一种。

**（2）产生原因：** 在一段时间内,传输错误的比特占所传输比特总数的比率称为**误码率BER(Bit Error Rate)**。误码率与信噪比有很大的关系。如果设法提高信噪比,就可以使误码率减小。实际的通信链路并非是理想的,它不可能使误码率下降到零。

**（3）解决方案：** 为了保证数据传输的可靠性,在计算机网络传输数据时,必须采用各种差错检测措施。目前在数据链路层广泛使用了**循环冗余检验CRC(Cyclic Redundancy Check)** 的检错技术。

**（4）循环冗余检验原理：** 在发送端,将数据划分为组,每组k个比特。CRC运算就是在k位比特数据的后面添加供差错检测用的n位冗余码,然后构成一个帧发送出去,一共发送(k+n)位。具体地，使用模2运算，将收到的k+n位数据（在其后添加n个0）除以事先商定的n+1位除数P，得到商R，n位余数R，这个余数R就作为冗余码拼接在数据M的后面发送出去。**冗余码常称为帧检验序列FCS(Frame Check Sequence)**。例如：M=101001(k=6)，除数P=1101(n=3)。经模2除法运算后的结果是:商Q=110101,余数R=001,具体计算过程如下：

![img](/img/2019-11-31-1.png)

​		在接收端把接收到的数据以帧为单位进行CRC检验:把收到的每一个帧都除以同样的除数P(模2运算),然后检查得到的余数R。如果在传输过程中无差错,那么经过CRC检验后得出的余数R肯定是0。但如果出现误码,那么余数R仍等于零的概率是非常非常小的。总之,在接收端对收到的每一帧经过CRC检验后,有以下两种情况：

* 若得出的余数R=0,则判定这个帧没有差错,就接受(accept)；
* 若余数R≠0,则判定这个帧有差错(但无法确定究竟是哪一位或哪几位出现了差错),就丢弃。

**（5）传输差错：** 若仅仅使用循环冗余检验CRC差错检测技术,则只能做到对帧的无差错接受，到的帧并没有出现比特差错,但出现了帧丢失、帧重复或帧失序，以上三种情况都属于传输差错。“无比特差错”与“无传输差错”并不是同样的概念。不要求在数据链路层提供可靠传输，即不要求在数据链路层解决帧丢失、帧重复或帧失序问题。

## 3. 点对点协议PPP

​		点对点协议PPP(Point-to-Point protocol)则是目前使用得最广泛的数据链路层协议。PPP协议就是用户计算机和ISP进行通信时所使用的数据链路层协议。

### 3.1 PPP协议设计要求

* 简单：CRC检验，正确就收下，反之就丢弃。
* 封装成帧：准确定位开始和结束。
* 透明性：转义字符保证透明传输。
* 多种网络层协议：支持多种网络层协议（如IP和IPX）。
* 多种链路类型：串行的(一次只发送一个比特)或并行的(一次并行地发送多个比特),同步的或异步的,低速的或高速的,电的或光的,交换的(动态的)或非交换的(静态的)点对点链路。
* 差错检测
* 检测连接状态：自动检测出链路是否处于正常工作状态。当出现故障的链路隔了一段时间后又重新恢复正常工作时,
  就特别需要有这种及时检测功能。
* 最大传送单元：PPP协议必须对每一种类型的点对点链路设置最大传送单元MTU的标准默认值，以促进各种实现之间的互操作性。
* 网络层地址协商：如果仅仅在链路层建立了连接而不知道对方网络层地址,则还不能够保证网络层可以传送分组。
* 数据压缩协商：PPP协议必须提供一种方法来协商使用数据压缩算法。但并不要求将数据压缩算法进行标准化。

​        **在TCP/P协议族中,可靠传输由运输层的TCP协议负责,因此数据链路层的PPP协议不需要进行纠错,不需要设置序号,也不需要进行流量控制。PPP协议不支持多点线路(即一个主机轮流和链路上的多个从主机进行通信),而只支持点对点的链路通信。此外,PPP协议只支持全双工链路。**

### 3.2 PPP协议的组成

* 一个将IP数据报封装到串行链路的方法。PPP既支持异步链路(无奇偶检验的8比特数据),也支持面向比特的同步链路。IP数据报在PPP帧中就是其信息部分。这个信息部分的长度受最大传送单元MTU的限制。
* 一个用来建立、配置和测试数据链路连接的**链路控制协议LCP(Link Control Protocol)**。
* 一套**网络控制协议NCP(Network Control Protocol)**,其中的每一个协议支持不同的网络层协议,如IP、OSI的网络层、 DECnet,以及AppleTalk等。

### 3.3 PPP协议的帧格式

（1）PPP帧的首部和尾部分别为四个字段和两个字段。

![img](/img/2019-11-31-2.png)

* 首部第一尾部第二：标志字段F(Flag),规定为0x7E(符号“0x”表示它后面的字符是用十六进制表示的,十六进制的7E的二进制表示是01111110), 标志字段就是PPP帧的定界符。如果出现连续两个标志字段,就表示这是一个空帧,应当丢弃。
* 首部第二：控制字段A规定为0xFF(即11111111)。
* 首部第三：控制字段C规定为0x03(即00000011)，这两个字段实际上并没有携带PPP帧的信息。
* 首部第四：PPP首部的第四个字段是2字节的协议字段。当协议字段为0x0021时,PPP帧的信息字段就是IP数据报。若为0xC021,则信息字段是PPP链路控制协议LCP的数据,而0x8021表示这是网络层的控制数据。
* 尾部第一：CRC的帧检验序列FCS（冗余码）。
* 信息字段：长度可变,不超过1500字节。

（2）**字节填充**：当信息字段中出现和标志字段一样的比特(0x7E)，并且使用**异步传输**时,转义符定义为0x7D,就必须采取措施使这种形式上和标志字段一样的比特组合不出现在信息字段中，字节填充方法如下：

* 把信息字段中出现的每一个0x7E字节转变成为2字节序列(0x7D,0x5E)。
* 若信息字段中出现一个0x7D的字节(转义字符),则把0x7D转变成为2字节序列(0x7D,0x5D)。
* 若信息字段中出现ASCII码的控制字符(即数值小于0x20的字符),则在该字符前面要加入一个0x7D字节,同时将该字符的编码加以改变。例如,出现0x03就要把它转变为2字节序列(0x7D,0x23)。
* 接收端在收到数据后再进行与发送端字节填充相反的变换,就可以正确地恢复出原来的信息。

（3）**零比特填充**：PPP协议用在SONET/SDH链路时,使用**同步传输**，在这种情况下,PPP协议采用零比特填充方法来实现透明传输。零比特填充的具体做法是：在发送端,先扫描整个信息字段(通常用硬件实现,但也可用软件实现,只是会慢些)。只要发现有5个连续1,则立即填入一个0。因此经过这种零比特填充后的数据,就可以保证在信息字段中不会出现6个连续1。接收端在收到一个帧时,先找到标志字段F以确定一个帧的边界,接着再用硬件对其中的比特流进行扫描。每当发现5个连续1时,就把这5个连续1后的一个0删除,以还原成原来的信息比特流，如下图。

![img](/img/2019-11-31-3.png)

### 3.4 PPP协议的工作状态

PPP链路初始化：

* 当用户拨号接入ISP后,就建立了一条从用户个人电脑到ISP的物理连接；

* 这时,用户个人电脑向ISP发送一系列的链路控制协议LCP分组(封装成多个PPP帧),以便建立LCP连接；
* 这些分组及其响应选择了将要使用的一些PPP参数。
* 接着还要进行网络层配置,网络控制协议NCP给新接入的用户个人电脑分配一个临时的IP地址。
* 当用户通信完毕时,NCP释放网络层连接,收回原来分配出去的IP地址
* 接着,LCP释放数据链路层连接。最后释放的是物理层的连接。

![img](/img/2019-11-31-4.png)

以下从中间分支箭头上的操作分步骤介绍具体初始化过程：

* **起初**：PPP链路的起始和终止状态永远是“链路静止”(Link Dead)状态,这时在用户个人电脑和ISP的路由器之间并不存在物理层的连接。
* **物理层连接建立**：当用户个人电脑通过调制解调器呼叫路由器时，路由器就能够检测到调制解调器发出的载波信号。**在双方建立了物理层连接后PPP就进入“链路建立”(Link establish)状态,其目的是建立链路层的LCP连接。**
* **LCP配置协商**：物理链路建立之后，开始进行LCP配置协商,即发送LCP的配置请求帧(Configure-Request)，这是一个PPP帧,其协议字段置为LCP对应的代码,而信息字段包含链路上的最大帧长、所使用的鉴别协议,以及不使用PPP帧中的地址和控制字段(因为这两个字段的值是固定的,没有任何信息量,可以在PPP帧的首部中省略这两个字节)。链路的另一端可以发送以下几种响应中的一种。**若配置失败，则转到链路静止状态，否则进入“鉴别”( Authenticate)状态**。
  - 配置确认帧(Configure-Ack)：所有选项都接受。
  - 配置否认帧(Configure-Nak)：所有选项都理解但不能接受。
  - 配置拒绝帧(Configure-Reject)：选项有的无法识别或不能接受,需要协商。

* **鉴别**：鉴别( Authenticate)状态只允许传送LCP协议的分组、鉴别协议的分组以及监测链路质量的分组。若使用**口
  令鉴别协议PAP(Password Authentication Protocol)**,则需要发起通信的一方发送身份标识符和口令。系统可允许用户重试若干次。还可以使用更加复杂安全的**口令握手鉴别协议CHAP(Challenge-Handshake Authentication Protocol)**。**若鉴别身份失败,则转到“链路终止”(Link Terminate)状态。若鉴别成功,则进入“网络层协议”(Network- Layer Protocol)状态**。
* **NCP配置协商**：在“网络层协议”状态,PPP链路的两端的网络控制协议NCP根据网络层的不同协议互相交换网络层特定的网络控制分组。**PPP协议两端的网络层可以运行不同的网络层协议,但仍然可使用同一个PPP协议进行通信**。如果在PPP链路上运行的是IP协议,则对PPP链路的每一端配置IP协议模块(如分配IP地址)时就要使用NCP中支持IP的协议——IP控制协议ICP(IP Control Protocol)。**当网络层配置完毕后,链路就进入可进行数据通信的“链路打开”(Link Open)状态**。
* **互发分组**。在链路打开状态下，链路的两个PPP端点可以彼此向对方发送分组。两个PPP端点还可发送回送请求LCP分组(Echo-Request)和回送回答LCP分组(Echo-Reply),以检查链路的状态。
* **终止请求**：数据传输结束后,可以由链路的一端发出终止请求LCP分组(Terminate-Request)请求终止链路连接,在收到对方发来的终止确认LCP分组(Terminate-Ack)后,转到“链路终止”状态。如果链路出现故障,也会从“链路打开”状态转到“链路终止”状态。当调制解调器的载波停止后,则回到“链路静止”状态。

## 4. 使用广播信道的数据链路层

​		**广播信道可以进行一对多的通信。局域网使用的就是广播信道。**

### 4.1 局域网的数据链路层

**（1）局域网简介**：局域网最主要的特点是:网络为一个单位所拥有,且地理范围和站点数目均有限。**局域网可按网络拓扑进行分类：星形网，环形网和总线网**。由于集线器(hub)的出现和双绞线大量用于局域网中,星形以太网以及多级星形结构的以太网获得了非常广泛的应用。双绞线已成为局域网中的主流传输媒体。当数据率很高时,往往需要使用光纤作为传输媒体。

![img](/img/2019-11-31-5.png)

**（2）共享信道**：在局域网要着重考虑的一个问题是**共享信道**，这在技术上有两种方法:

* **静态划分信道**：如之前介绍过的频分复用、时分复用、波分复用和码分复用等。用户只要分配到了信道就不会和其他用户发生冲突。但**这种划分信道的方法代价较高,不适合于局域网使用。**
* **动态媒体接入控制**：又称为多点接入(multiple access),其特点是信道并非在用户通信时固定分配给用户。这里又分为以下两类：
  * **随机接入**：**所有的用户可随机地发送信息**。但如果恰巧有两个或更多的用户在同一时刻发送信息,那么在共享媒体上就要产生碰撞,使得这些用户的发送都失败。因此,**必须有解决碰撞的网络协议**。这也是本章介绍的重点。
  * **受控接入**：**用户不能随机地发送信息而必须服从一定的控制**。这类的典型代表有分散控制的令牌环局域网和集中控制的多点线路探询(polling),或称为轮询。受控接入在局域网中使用得较少。

**（3）MAC协议**：为了使数据链路层能更好地适应多种局域网标准,IEEE802委员会就把局域网的数据链路层拆成两个子层,即**逻辑链路控制LLC(Logical Link Control)子层**和**媒体接入控制MAC(Medium Access Control)子层**。**而TCP/IP体系经常使用的局域网仅装有MAC协议而没有LLC协议。**

**（4）适配器**：计算机与外界局域网的连接是通过通信**适配器(adapter，或称网卡)** 进行的。在这种通信**适配器上面装有处理器和存储器(包括RAM和ROM)**。适配器和局域网之间的通信是通过电缆或双绞线以串行传输方式进行的而适配器和计算机之间的通信则是通过计算机主板上的LO总线以并行传输方式进行的。因此,**适配器的一个重要功能就是要进行数据串行传输和并行传输的转换**。由于网络上的数据率和计算机总线上的数据率并不相同,因此在适配器中必须装有对数据进行缓存的存储芯片。在主板上插入适配器时,还必须**把管理该适配器的设备驱动程序安装**在计算机的操作系统中。适配器还要能够实现以太网协议。适配器在接收和发送各种帧时,不使用计算机的CPU。这时计算机中的CPU可以处理其他任务。当适配器收到有差错的帧时,就把这个帧直接丢弃而不必通知计算机。当适配器收到正确的帧时,它就使用中断来通知该计算机,并交付协议栈中的网络层。当计算机要发送IP数据报时,就由协议栈把IP数据报向下交给适配器,组装成帧后发送到局域网。**计算机的硬件地址就在适配器的ROM中**,而计算机的软件地址—P地址在计算机的存储器中。

![img](/img/2019-11-31-6.png)

### 4.2 CSMA/CD协议

**（1）总线型一对一通信**：最早的以太网是总线型的，当一台计算机发送数据时,总线上的所有计算机都能检测到这个数据，属于广播通信。为了在总线上实现一对一的通信,可以使每一台计算机的适配器拥有一个与其他适配器都不同的地址。在发送数据帧时,在帧的首部写明接收站的地址，仅当数据帧中的目的地址与适配器ROM中存放的硬件地址一致时,该适配器才能接收这个数据帧。适配器对不是发送给自己的数据帧就丢弃。

**（2）以太网通信措施**：

* **第一,采用较为灵活的无连接的工作方式**：不必先建立连接就可以直接发送数据适配器对发送的数据帧不进行编号,也不要求对方发回确认。因此,以太网提供的服务是尽最大努力的交付,即不可靠的交付。当目的站收到有差错的数据帧时,就把帧丢弃。对有差错帧是否需要重传则由高层（TCP协议，若TCP发现丢失了数据，就把这些数据重新传递给以太网进行重传，但以太网并不知道这是重传帧）来决定。在同一时间只能允许一台计算机发送数据,否则各计算机之间就会互相干扰,使得所发送数据被破坏。**以太网采用最简单的随机接入,并使用CSMA/CD**（载波监听多点接入/碰撞检测，Carrier Sense Multiple Access with Collision Detection）**协议以减少冲突发生的概率**。
* **第二,以太网发送的数据都使用曼彻斯特(Manchester)编码**，每一个码元的正中间出现一次电压的转换,而接收端就利用这种电压的转换很方便地把位同步信号提取出来。曼彻斯特编码的缺点是它所占的频带宽度比原始的基带信号增加了一倍(因为每秒传送的码元数加倍了)。

**（3）CSMA/CD载波监听多点接入/碰撞检测协议**：

* “**多点接入**”就是说明这是总线型网络,许多计算机以多点接入的方式连接在一根总线上。协议的实质是“载波监听”和“碰撞检测”。
* “**载波监听**”就是用电子技术检测总线上有没有其他计算机也在发送，就是检测信道,不管在发送前,还是在发送中,每个主机都必须不停地检测信道。在发送前检测信道,是为了获得发送权。在发送中检测信道,是为了及时发现有没有其他站的发送和本站发送的碰撞。这就称为碰撞检测。
* “**碰撞检测**”也就是“边发送边监听”,即适配器边发送数据边检测信道上的信号电压的变化情况,以便判断自己在发送数据时其他站是否也在发送数据。当几个站同时在总线上发送数据时,总线上的信号电压变化幅度将会增大(互相叠加)。当适配器检测到的信号电压变化幅度超过一定的门限值时,就认为总线上至少有两个站同时在发送数据,表明产生了碰撞。一旦发现总线上出现了碰撞,其适配器就要立即停止发送,然后等待一段随机时间后再次发送。

**（4）碰撞起因** 

* 既然每一个站在发送数据之前已经监听到信道为“空闲”,那么为什么还会出现数据在总线上的碰撞呢?
* 这是因为电磁波在总线上总是以有限的速率传播的，若是在这个传播时延内有多台主机检测到空闲，并发送数据，则发生冲突。

**（5）碰撞分析**

- 把总线上的单程端到端传播时延记为τ，最迟经过2τ的时间发送端能检测到碰撞，即总线的端到端往返传播时延。
- 显然,在使用 CSMA/CD协议时,**一个主机不可能同时进行发送和接收**(但必须边发送边监听信道)。因此使用 CSMA/CD协议的以太网不可能进行全双工通信而**只能进行双向交替通信(半双工通信)**。
- **每一个站在自己发送数据之后的一小段时间内,存在着遭遇碰撞的可能性。这一小段时间是不确定的,它取决于另一个发送数据的站到本站的距离。以太网的这一特点称为发送的不确定性**。如果希望在以太网上发生碰撞的机会很小，必须使整个以太网的平均通信量远小于以太网的最高数据率。
- 以太网的端到端往返时间2τ称为争用期(contention period),又称为碰撞窗口(collision window)。这是因为一个站在发送完数据后,**经过争用期这段时间还没有检测到碰撞,才能肯定这次发送不会发生碰撞。**

**（6）碰撞解决方案**

**以太网使用截断二进制指数退避(truncated binary exponential backoff)算法来确定碰撞后重传的时机**。这种算法让发生碰撞的站在停止发送数据后,**推迟(这叫做退避)一个随机的时间再次发送**。因为如果几个发生碰撞的站都在监听信道,那么都会同时发现信道变成了空闲。如果大家都同时再重新发送,那么肯定又会发生碰撞。为了使各站进行重传时再次发生冲突的概率减小,具体的退避算法如下:

* 协议规定了基本退避时间为争用期2τ,**争用期时间具体是51.2us**。对于10 Mbit/s以太网,在争用期内可发送512bit,即64字节。也可以说争用期是512比特时间。
* 从离散的整数集合$[0,1,…,(2^k-1)]$中随机取出一个数,记为r。重传应推后的时间就是r倍的争用期。参数$k=Min[重传次数，10]$,当重传次数不超过10时,参数k等于重传次数;但当重传次数超过10时,k就不再增大而一直等于10。
* 当重传达16次仍不能成功时(这表明同时打算发送数据的站太多,以致连续发生突),则丢弃该帧,并向高层报告。

**（7）指数退避算法分析**

* 适配器每发送一个新的帧,就要执行一次 CSMA/CD算法。适配器对过去发生过的碰撞并无记忆功能。因此,当好几个适配器正在执行指数退避算法时,很可能有某一个适配器发送的新帧能够碰巧立即成功地插入到信道中,得到了发送权,而已经推迟好几次发送的站,有可能很不巧,还要继续执行退避算法,继续等待。
* **若发送数据小于争用期512bit，发送端边发送边侦听，如果发生冲突并用了51.2us冲突回传回来时，早就发完了，那发送站认为这个碰撞不是自己的帧，因而不会重传这个帧**。为了避免发生这种情况,以太网规定了一个最短帧长64字节,即512bit。如果要发送的数据非常少,那么必须加入一些填充字节,使帧长不小于64字节。对于10Mbit/s以太网,发送512bit的时间需要51.2us,也就是上面提到的争用期。
* 由此可见,**以太网在发送数据时,如果在争用期(共发送了64字节)没有发生碰撞那么后续发送的数据就一定不会发生冲突**。换句话说,如果发生碰撞,就一定是在发送的前64字节之内。由于一检测到冲突就立即中止发送,这时已经发送出去的数据一定小于64字节,因此凡长度小于64字节的帧都是由于冲突而异常中止的无效帧。只要收到了这种无效帧,就应当立即将其丢弃。

**（8）强化碰撞**

​		当发送数据的站一旦发现发生了碰撞时,除了立即停止发送数据外,还要再继续发送32比特或48比特的人为干扰信号 (jamming signal),以便让所有用户都知道现在已经发生了碰撞。

​		以太网还规定了**帧间最小间隔为96μs,相当于96比特时间。这样做是为了使刚刚收到数据帧的站的接收缓存来得及清理**,做好接收下一帧的准备。

### 4.3 集线器与星型拓扑

集线器的一些特点如下：

* 从表面上看,使用集线器的局域网在物理上是一个星形网,但使用集线器的以太网在逻辑上仍是一个总线网,各主机共享逻辑上的总线,各主机中的适配器执行CSMA/CD协议)，，在同一时刻至多只允许一个主机发送数据。
* 集线器工作在物理层,它的每个接口仅仅简单地转发比特——收到1就转发1,收到0就转发0,不进行碰撞检测。若两个接口同时有信号输入(即发生碰撞),那么所有的接口都将收不到正确的帧。
* 集线器采用了专门的芯片,进行自适应串音回波抵消。这样就可使接口转发出去的较强信号不致对该接口接收到的较弱信号产生干扰(这种干扰即近端串音)。每个比特在转发之前还要进行再生整形并重新定时。
* 集线器一般都有少量的容错能力和网络管理功能。例如,假定在以太网中有一个适配器出了故障,不停地发送以太网帧。这时,集线器可以检测到这个问题,在内部断开与出故障的适配器的连线,使整个以太网仍然能够正常工作。

### 4.4 以太网的信道利用率

​		假定一个10 Mbit/s以太网同时有10个站在工作,那么每一个站所能发送数据的平均速率似乎应当是总数据率的1/10(即1Mbit/s)。但由于碰撞的存在，信道资源会造成浪费。因此,以太网总的信道利用率并不能达到100%。

​		下图的例子是以太网的信道被占用的情况。一个站在发送帧时出现了碰撞。经过若干个争用期后,发送成功了。假定发送帧需要的时间是$T_0$。它等于帧长(bit除以发送速率(10 Mbit/s)。成功发送一个帧需要占用信道的时间是$T_0+τ$,也就是发送时延+传播时延。

![img](/img/2019-11-31-7.png)

​		**要提高以太网的信道利用率,就必须减小$τ$与$T_0$之比。在以太网中定义了参数$a=\frac{τ}{T_0}$,当a→0时,只要一发生碰撞,就立即可以检测出来,并立即停止发送,因而信道资源被浪费的时间非常非常少**。以太网的参数a的值应当尽可能小些,这就要求分子数值要小些,而分母的数值要大些。

​	现在考虑一种理想化的情况，假定以太网上的各站发送数据都不会产生碰撞,即总线一旦空闲就有某一个站立即发送数据,于是我们可计算出极限信道利用率$S_{max}=\frac{T_0}{T_0+τ}=\frac{1}{1+a}$,指出了只有当参数$a$远小于1才能得到尽可能高的极限信道利用率。

### 4.5 以太网的MAC层

（1）在局域网中,**硬件地址又称为物理地址或MAC地址**(因为这种地址用在MAC帧中)，是指局域网上的每台计算机中**固化在适配器的ROM中**的48位（6字节）的地址。IEEE的**注册管理机构RA(Registration Authority)** 负责分配地址字段的6个字节中的**前三个字节**(即高位24位)给生产局域网适配器的厂家,称为**组织唯一标识符OUI(Organizationally Unique Identifier)**。地址字段中的**后三个字节**(即低位24位)则由厂家自行指派称为**扩展标识符(extended identifier)**,只要保证生产出的适配器没有重复地址即可。一个公司可能有几个OUI,也可能有几个小公司合起来购买一个OUI。

（2）**MAC帧格式**

​	常用的以太网MAC帧格式有两种标准,一种是 DIX Ethernet V2标准(即以太网V2标准),准),另一种是IEEE的802.3标准。这里只介绍使用得最多的以太网V2的MAC帧格式。以太网V2的MAC帧由五个字段组成：**目的地址（6字节）**，**源地址（6字节）**，**类型字段（2字节**，标志上一层使用的是什么协议，0x0800表示上层使用的是IP数据报，0x8137表示该帧是由 Novell IPX发过来的），**数据字段（46到1500字节**，46字节=最小长度64字节-18字节的收尾），**帧检验序列FCS（4字节**，使用CRC检验）。

![img](/img/2019-11-31-8.png)

（3）**数据长度判断**

​		以上MAC帧格式并**没有帧长度(或数据长度)字段**，接收方依据曼彻斯特编码的特性（每个码元中间有一次电压转换）确定数据字段的长度。但是**当数据字段的长度小于46字节时**,MAC子层就会在数据字段的后面加入**填充字段**,但MAC帧的首部并没有指出数据字段的长度是多少，上层协议如何知道填充字段的长度呢?
​		当上层使用IP协议时,其首部就有一个“总长度”字段。因此,**“总长度”加上填充字段的长度,应当等于MAC帧数据字段的长度**。例如,当IP数据报的总长度为42字节时,填充字段共有4字节。当MAC帧把46字节的数据上交给IP层后,IP层就把其中最后4字节的填充字段丢弃。

（4）**位同步**	

​		为了接收端迅速**实现位同步**,从MAC子层向下传到物理层时还要在帧的前面**插入8字节**(由硬件生成),它由两个字段构成。第一个字段是**7个字节的前同步码**,它的作用是使接收端的适配器在接收MAC帧时能够迅速调整其时钟频率,使它和发送端的时钟同步。第二个字段是帧开始定界符,定义为10101011，它的前六位的作用和前同步码一样,最后的两个连续的1就是告诉接收端适配器:“MAC帧的信息马上就要来了,请适配器注意接收”。

（5）**无效的MAC帧**

- 帧的长度不是整数个字节；
- 用收到的帧检验序列FCS查出有差错
- 收到的帧的MAC客户数据字段的长度不在46~1500字节之间。

## 5. 扩展的以太网

### 5.1 在物理层扩展以太网

​		以太网上的主机之间的距离不能太远,否则主机发送的信号经过铜线的传输就会衰减到使CSMA/CD协议无法正常工作。现在,扩展主机和集线器之间的距离的一种简单方法就是使用光纤和一对光纤调制解调器。光纤调制解调器的作用就是进行电信号和光信号的转换。如果使用多个集线器,就可以连接成覆盖更大范围的多级星形结构的以太网。

![img](/img/2019-11-31-9.png)

**优点**：跨独立以太网通信，扩大了以太网覆盖的地理范围。

**缺点**：三个独立以太网的通过集线器互连起来后就把三个碰撞域变成一个碰撞域，且这时的最大吞吐量仍然是单个以太网的吞吐量。如果不同的独立以太网使用不同的以太网技术(如数据率不同),那么就不可能用集线器将们互连起来。如上图中,一个系使用10Mbit/s的适配器,而另外两个系使用100Mbit/s的适配器,那么用集线器连接起来后,大家都只能工作在10 Mbit/s的速率。

### 5.2 数据链路层扩展以太网

（1）**扩展以太网更常用的方法是在数据链路层进行**。最初使用的是**网桥(bridge)**。网桥对收到的帧根据其MAC帧的目的地址进行转发和过滤。当网桥收到一个帧时,并不是向所有的接口转发此帧,而是根据此帧的目的MAC地址,查找网桥中的地址表,然后确定将该帧转发到哪一个接口,或者是把它丢弃(即过滤)。**交换式集线器(switching hub，或称为以太网交换机(switch)或第二层交换机(L2 switch))**的出现很快就淘汰了网桥。**以太网交换机的特点：**

* 太网交换机实质上就是一个多接口的网桥**,通常都有十几个或更多的接口,**以太网交换机的每个接口都直接与一个单台主机或另一个以太网交换机相连,并且一般都工作在全双工方式**。
* 以太网交换机还具有**并行性**,即能同时连通多对接口,使多对主机能同时通信(而网桥只能一次分析和转发一个帧)。**相互通信的主机都是独占传输媒体,无碰撞地传输数据**。
* 以太网交换机的接口还有**存储器**,能在输出端口繁忙时把到来的帧进行**缓存**。
* 以太网交换机是一种**即插即用设备**,其内部的**帧交换表(又称为地址表)是通过自学习算法**自动地逐渐建立起来的。
* 对于传统的10 Mbit/s的共享式以太网,若共有10个用户,则每个用户占有的平均带宽只有1Mbis。若使用以太网交换机来连接这些主机,虽然在每个接口到主机的带宽还是10Mbit/s,但由于一个用户在通信时是独占而不是和其他网络用户共享传输媒体的带宽,因此对于拥有10个接口的交换机的总容量则为100 Mbit/s。这正是交换机的最大优点。
* 以太网交换机一般都具有多种速率的接口,例如,可以具有10 Mbit/s、100Mbit/s和1Gbit/s的接口的各种组合,这就大大方便了各种不同情况的用户。
  虽然许多以太网交换机对收到的帧采用存储转发方式进行转发,但也有一些交换机采
  用直通 ( cut-through)的交换方式。直通交换不必把整个数据帧先缓存后再进行处理,而是在
  接收数据帧的同时就立即按数据帧的目的MAC地址决定该帧的转发接口,因而提高了帧的
  转发速度。如果在这种交换机的内部采用基于硬件的交叉矩阵,交换时延就非常小。直通交

（2）**以太网交换机的自学习功能**

- 当交换机不知道哪个接口对应哪个MAC主机时，就采用广播的方式，然后将过滤后的MAC地址和接口号对应填入交换表；
- 当交换表已知某个帧的目的MAC地址对应接口时，不必要广播，直接转发。
- 考虑到有时可能要在交换机的接口更换主机,这就需要更改交换表中的项目。为此,在交换表中每个项目都设有一定的有效时间。过期的项目就自动被删除。

（3）**从总线以太网到星形以太网**

​		**总线以太网使用 CSMA/CD协议,以半双工方式工作。但以太网交换机不使用共享总线,没有碰撞问题,因此不使用 CSMA/CD协议,而是以全双工方式工作。既然连以太网的重要协议CSMA/CD都不使用了,为什么还叫做以太网呢?原因就是它的帧结构未改变,仍然采用以太网的帧结构。**

### 5.3 虚拟局域网

（1）**概念**：虚拟局域网VLAN(Virtual LAN)是由一些局域网网段构成的**与物理位置无关的逻辑组**。**每一个VLAN的帧都有一个明确的标识符,指明发送这个帧的计算机属于哪一个VLAN**。虚拟局域网其实只是局域网给用户提供的一种服务,而并不是一种新型局域网。

![img](/img/2019-11-31-10.png)

（2）**实例**

`LAN1:(A1,A2,B1,C1),LAN2:(A3,B2,C2),LAN3:(A4,B3,C3)`这10个用户划分为三个物理工作组,同时被划分为三个逻辑虚拟局域网VLAN`VLAN1:(Al, A2, A3, A4), VLAN2: (Bl, B2, B3): VLAN3: (Cl, C2, C3)`

（3）**工作原理**

​		虚拟局域网协议允许**在以太网的帧格式中插入一个4字节的标识符**，称为VLAN标记(tag),用来指明发送该帧的计算机属于哪一个虚拟局域网。插入VLAN标记得出的帧称为**802.1Q帧**。

![img](/img/2019-11-31-11.png)

​		VLAN标记字段的长度是4字节,插入在以太网MAC帧的源地址字段和类型字段之间。VLAN标记的前两个字节总是设置为0x8100(图中显示的是二进制),称为**IEEE802.1Q标记类型**。在后面的两个字节中,前3位是用户优先级字段,接着的一位是规范格式指示符CFI(Canonical FormatIndicator),最后的12位是该虚拟局域网VLAN标识符 VID (VLAN ID),它唯一地标志了这个以太网帧属于哪一个VLAN。由于用于VLAN的以太网帧的首部增加了4个字节,因此以太网的最大帧长从原来的1518字节(1500字节的数据加上18字节的首部)变为1522字节。





























